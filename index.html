<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ä¸ªæ€§åŒ–é±¼å¡˜æ¨¡æ‹Ÿå™¨ - è‡ªåŠ¨æ”¶é›†ç‰ˆ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0d47a1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #game-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        /* UI é¢æ¿ */
        .ui-panel {
            pointer-events: none;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .interactive {
            pointer-events: auto;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .fish-card-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        #file-input {
            display: none;
        }
    </style>
</head>

<body>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="game-canvas"></canvas>

    <!-- UI é¢æ¿ -->
    <div class="ui-panel flex flex-col justify-between p-4">

        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="flex justify-between items-start">

            <!-- å·¦ä¾§ï¼šé‡‘å¸ / æ¸…æ´åº¦ / å®¹é‡ -->
            <div class="glass-panel p-3 flex flex-col gap-2 interactive min-w-[150px]">
                <div class="flex items-center gap-2 text-yellow-600 font-bold text-lg">
                    <i class="fas fa-coins"></i> 
                    <span id="money-display">0</span>
                </div>

                <div class="text-sm text-gray-700 font-medium">
                    <div>
                        <i class="fas fa-water text-blue-500"></i>
                        æ¸…æ´åº¦: <span id="cleanliness-display">100</span>%
                    </div>

                    <div>
                        <i class="fas fa-fish text-pink-500"></i>
                        å®¹é‡: <span id="count-display">0</span> / 
                        <span id="capacity-display">3</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé±¼è¯¦æƒ…é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="fish-detail"
                class="glass-panel p-4 hidden flex-col w-64 interactive fish-card-enter relative bg-white/95">

                <button onclick="ui.closeDetail()"
                    class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>

                <div class="text-center mb-2">

                    <!-- é±¼å¤´åƒé¢„è§ˆ -->
                    <div id="detail-preview"
                        class="w-16 h-16 rounded-full mx-auto mb-2 border-4 border-white shadow-md bg-cover bg-center bg-no-repeat">
                    </div>

                    <!-- å¯ä¿®æ”¹åå­— -->
                    <div class="flex items-center gap-2 justify-center">
                        <input id="detail-name-input"
                            class="text-center font-bold text-gray-800 text-lg border border-gray-300 rounded px-2 py-0.5 w-28
                                   focus:outline-none focus:ring-2 focus:ring-blue-400">

                        <button id="detail-name-save"
                            class="text-xs px-2 py-0.5 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                            ä¿å­˜
                        </button>
                    </div>

                    <span id="detail-personality"
                        class="text-xs mt-1 px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full font-bold">
                        æ€§æ ¼
                    </span>
                </div>

                <!-- ä¸‰æ¡çŠ¶æ€æ¡ -->
                <div class="space-y-3 text-sm mt-2">

                    <div class="flex items-center gap-2">
                        <i class="fas fa-heart text-red-500 w-5"></i>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                            <div id="bar-health" class="bg-red-500 h-full rounded-full transition-all duration-500"
                                style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <i class="fas fa-smile text-yellow-500 w-5"></i>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                            <div id="bar-mood" class="bg-yellow-500 h-full rounded-full transition-all duration-500"
                                style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <i class="fas fa-utensils text-orange-500 w-5"></i>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                            <div id="bar-hunger" class="bg-orange-500 h-full rounded-full transition-all duration-500"
                                style="width: 50%"></div>
                        </div>
                    </div>

                </div>

                <div id="detail-status"
                    class="mt-3 text-xs text-center text-gray-500 italic font-medium">
                    æ­£åœ¨å‘å‘†â€¦
                </div>
            </div>
        </div>
<script>
/**
 * é…ç½®ä¸å¸¸é‡
 */
const CONFIG = {
    FOOD_PRICE: 2,
    EXPAND_PRICE: 200,
    POOP_DECAY: 0.005,
    CLEAN_RECOVERY: 30,
    TICK_RATE: 60
};

const PERSONALITIES = [
    { type: 'æ´»æ³¼', speedMod: 1.5, hungerMod: 1.3, color: '#FF6B6B' },
    { type: 'å‘†èŒ', speedMod: 0.6, hungerMod: 0.8, color: '#4ECDC4' },
    { type: 'å‚²å¨‡', speedMod: 1.1, hungerMod: 1.0, color: '#FFE66D', prodMod: 1.2 },
    { type: 'å¿§éƒ', speedMod: 0.5, hungerMod: 0.9, color: '#D4A5A5' },
    { type: 'æš´èº', speedMod: 1.8, hungerMod: 1.5, color: '#FF4757' }
];

const FOOD_TYPES = {
    basic: { nutrition: 40, color: '#8B4513', radius: 5 }
};

/**
 * å·¥å…·å‡½æ•°
 */
function randomRange(min, max) { return Math.random() * (max - min) + min; }
function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function stringHash(str) {
    let h = 0;
    for (let i = 0; i < str.length; i++) {
        h = ((h << 5) - h) + str.charCodeAt(i);
        h |= 0;
    }
    return Math.abs(h);
}

/**
 * å®ä½“ç±»åŸºç±»
 */
class Entity {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.remove = false;
    }
    update() {}
    draw() {}
}

/**
 * æµ·è‰ï¼ˆèƒŒæ™¯æ‘†åŠ¨ï¼‰
 */
class Seaweed {
    constructor(x, height) {
        this.x = x;
        this.height = height;
        this.segments = 5;
        this.segmentHeight = height / 5;
        this.offset = randomRange(0, Math.PI * 2);
    }

    draw(ctx, time) {
        ctx.beginPath();
        ctx.moveTo(this.x, window.innerHeight);

        let cx = this.x;
        let cy = window.innerHeight;

        for (let i = 1; i <= this.segments; i++) {
            const sway = Math.sin(time * 0.002 + this.offset + i * 0.5) * (i * 3);
            const nx = this.x + sway;
            const ny = window.innerHeight - (i * this.segmentHeight);

            ctx.quadraticCurveTo(cx, cy - this.segmentHeight/2, nx, ny);
            cx = nx;
            cy = ny;
        }

        ctx.lineWidth = 4;
        ctx.strokeStyle = '#2E7D32';
        ctx.stroke();

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#66BB6A';
        ctx.stroke();
    }
}

/**
 * æ°”æ³¡ï¼ˆèƒŒæ™¯ä¸Šå‡ï¼‰
 */
class BubbleParticle extends Entity {
    constructor() {
        super(randomRange(0, window.innerWidth), window.innerHeight + 10);
        this.radius = randomRange(1, 4);
        this.vy = randomRange(0.5, 2);
        this.opacity = randomRange(0.1, 0.4);
        this.wobble = randomRange(0, Math.PI * 2);
    }

    update() {
        this.y -= this.vy;
        this.x += Math.sin(this.y * 0.01 + this.wobble) * 0.5;
        if (this.y < -10) this.y = window.innerHeight + 10;
    }

    draw(ctx) {
        ctx.globalAlpha = this.opacity;
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

/**
 * é£Ÿç‰©
 */
class Food extends Entity {
    constructor(x, y, type) {
        super(x, y);
        this.props = FOOD_TYPES[type];
        this.vy = 2.0;
    }

    update() {
        if (this.y < window.innerHeight - 30) {
            this.y += this.vy;
            this.vy *= 0.99;
            if (this.vy < 0.5) this.vy = 0.5;
        } else {
            if (Math.random() < 0.005) this.remove = true;
        }
    }

    draw(ctx) {
        ctx.fillStyle = this.props.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.props.radius, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath();
        ctx.arc(this.x - 1, this.y - 1, this.props.radius * 0.4, 0, Math.PI * 2);
        ctx.fill();
    }
}

/**
 * ç²‘ç²‘
 */
class Poop extends Entity {
    constructor(x, y, color) {
        super(x, y);
        this.color = color;
        this.vy = 0.8;
        this.rotation = Math.random() * Math.PI;
        this.opacity = 1;
    }

    update() {
        if (this.y < window.innerHeight - 30) {
            this.y += this.vy;
        }
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.globalAlpha = this.opacity;

        ctx.fillStyle = '#4e342e';
        ctx.beginPath();
        ctx.ellipse(0, 0, 6, 4, 0, 0, Math.PI * 2);
        ctx.ellipse(3, -2, 4, 3, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
}

/**
 * é‡‘å¸
 */
class Coin extends Entity {
    constructor(x, y, value) {
        super(x, y);
        this.value = value;
        this.vy = -1.5;
        this.life = 400;
        this.scale = 0;
        this.wobbleOffset = Math.random() * 100;
        this.autoCollectTimer = 90;
    }

    update() {
        this.y += this.vy;
        this.x += Math.sin((this.life + this.wobbleOffset) * 0.1) * 0.5;
        this.life--;
        if (this.scale < 1) this.scale += 0.1;
        this.autoCollectTimer--;

        if (this.life <= 0 || this.y < -20) this.remove = true;
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.scale(this.scale, this.scale);

        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath();
        ctx.arc(0, 0, 16, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = 'rgba(255,255,255,0.6)';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(0, 0, 10, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = '#F57F17';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, 0, 7, 0, Math.PI * 2);
        ctx.stroke();

        ctx.fillStyle = '#F57F17';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('$', 0, 0);

        ctx.restore();
    }
}

/**
 * é±¼ç±»ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
 */
class Fish extends Entity {
    constructor(id, seed, name, image) {
        super(window.innerWidth / 2, randomRange(100, window.innerHeight - 100));

        this.id = id;
        this.name = name;
        this.image = image;

        const p = PERSONALITIES[seed % PERSONALITIES.length];
        this.traits = p;
        this.personality = p.type;
        this.baseColor = p.color;

        this.health = 100;
        this.mood = 100;
        this.hunger = 80;

        this.vx = randomRange(-1, 1);
        this.vy = randomRange(-0.5, 0.5);
        this.baseSpeed = 1.2 * p.speedMod;

        this.poopTimer = randomInt(800, 1500);
        this.coinTimer = randomInt(300, 600);

        this.tailAngle = 0;
        this.tailSpeed = 0.2;

        this.state = "WANDER";
        this.changeDirTimer = 0;
    }

    update(dt, foods, clean) {
        /**
         * 1. ç¯å¢ƒå½±å“
         */
        if (clean < 60) {
            this.health -= 0.005;
            this.mood -= 0.01;
        }

        this.hunger -= 0.015 * this.traits.hungerMod;
        if (this.hunger < 0) this.hunger = 0;

        if (this.hunger < 30) this.mood -= 0.02;

        if (this.hunger > 80 && clean > 80 && this.health < 100) {
            this.health += 0.03;
        }

        if (this.health < 30) this.state = "SICK";
        else this.state = "WANDER";

        /**
         * 2. çŠ¶æ€è¡Œä¸º
         */
        if (this.state === "SICK") {
            this.vx *= 0.9;
            this.vy *= 0.9;
            if (this.y < window.innerHeight - 50) this.vy += 0.05;
            this.tailSpeed = 0.05;
        } else {
            this.tailSpeed = 0.2;

            this.changeDirTimer--;
            if (this.changeDirTimer <= 0) {
                const ang = randomRange(0, Math.PI * 2);
                this.vx += Math.cos(ang) * 0.1;
                this.vy += Math.sin(ang) * 0.1;
                this.changeDirTimer = randomInt(50, 150);
            }

            const sp = Math.hypot(this.vx, this.vy);
            if (sp > this.baseSpeed) {
                this.vx = (this.vx / sp) * this.baseSpeed;
                this.vy = (this.vy / sp) * this.baseSpeed;
            }
        }

        /**
         * 3. ç§»åŠ¨ & çº¦æŸ
         */
        this.x += this.vx;
        this.y += this.vy;

        const pad = 30;
        if (this.x < pad) this.vx += 0.2;
        if (this.x > window.innerWidth - pad) this.vx -= 0.2;
        if (this.y < pad) this.vy += 0.2;
        if (this.y > window.innerHeight - pad) this.vy -= 0.2;

        /**
         * 4. äº§ç²‘ç²‘ / äº§å¸
         */
        this.poopTimer--;
        if (this.poopTimer <= 0) {
            this.poopTimer = randomInt(1500, 3000);
            game.spawnPoop(this.x, this.y, this.baseColor);
        }

        this.coinTimer--;
        if (this.coinTimer <= 0) {
            this.coinTimer = randomInt(600, 1000) / (this.traits.prodMod || 1);
            if (this.health > 50 && this.mood > 50 && this.hunger > 30) {
                game.spawnCoin(this.x, this.y - 20, 10);
            }
        }

        /**
         * 5. åŠ¨ç”»
         */
        this.tailAngle += this.tailSpeed * (Math.hypot(this.vx, this.vy) + 0.5);
    }

    /**
     * åƒé£Ÿç‰©
     */
    eat(food) {
        this.hunger = Math.min(100, this.hunger + food.props.nutrition);
        this.mood = Math.min(100, this.mood + 10);
        this.health = Math.min(100, this.health + 5);

        game.showToast(`ğŸ˜‹ ${this.name} åƒåˆ°äº†é£Ÿç‰©ï¼`, 900);

        for (let i = 0; i < 5; i++) {
            game.createParticle(this.x, this.y, ".", food.props.color);
        }
    }

    /**
     * ç»˜åˆ¶é±¼
     */
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);

        if (this.health < 30) ctx.filter = "grayscale(100%) brightness(0.7)";

        const flip = this.vx < 0;
        if (flip) ctx.scale(-1, 1);

        /* å°¾å·´ */
        const tail = Math.sin(this.tailAngle) * 5;
        ctx.fillStyle = this.baseColor;
        ctx.beginPath();
        ctx.moveTo(-15, 0);
        ctx.lineTo(-30, -10 + tail);
        ctx.lineTo(-30, 10 + tail);
        ctx.fill();

        /* èº«ä½“é®ç½© */
        ctx.beginPath();
        ctx.ellipse(0, 0, 24, 16, 0, 0, Math.PI * 2);
        ctx.save();
        ctx.clip();

        ctx.fillStyle = this.baseColor;
        ctx.fill();

        if (this.image) {
            ctx.globalCompositeOperation = "overlay";
            ctx.drawImage(this.image, -24, -24, 48, 48);

            ctx.globalCompositeOperation = "source-over";
            ctx.globalAlpha = 0.7;
            ctx.drawImage(this.image, -24, -24, 48, 48);
        }

        ctx.restore();

        /* é³ */
        ctx.fillStyle = this.baseColor;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.moveTo(0, 4);
        ctx.quadraticCurveTo(-5, 12, -10, 6);
        ctx.fill();
        ctx.globalAlpha = 1;

        /* çœ¼ç› */
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(10, -6, 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.arc(12, -6, 2, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(13, -7, 1, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
}
/**
 * æ¸¸æˆä¸»æ§ç±»
 */
class Game {
    constructor() {
        this.canvas = document.getElementById("game-canvas");
        this.ctx = this.canvas.getContext("2d");
        this.resize();

        this.fishes = [];
        this.foods = [];
        this.poops = [];
        this.coins = [];
        this.bubbles = [];
        this.seaweeds = [];
        this.textParticles = [];

        this.money = 400;
        this.maxCapacity = 3;
        this.cleanliness = 100;
        this.selectedFish = null;

        /* åˆå§‹åŒ–èƒŒæ™¯æµ·è‰ */
        for (let i = 0; i < window.innerWidth; i += randomInt(60, 120)) {
            this.seaweeds.push(new Seaweed(i, randomRange(100, 200)));
        }

        /* åˆå§‹åŒ–æ°”æ³¡ */
        for (let i = 0; i < 20; i++) {
            this.bubbles.push(new BubbleParticle());
        }

        /* äº‹ä»¶ */
        window.addEventListener("resize", () => this.handleResize());
        this.canvas.addEventListener("click", (e) => this.handleClick(e));

        this.loop();
        this.updateUI();
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    handleResize() {
        this.resize();
        this.seaweeds = [];
        for (let i = 0; i < window.innerWidth; i += randomInt(60, 120)) {
            this.seaweeds.push(new Seaweed(i, randomRange(100, 200)));
        }
    }

    /**
     * ä¸Šä¼ å›¾ç‰‡ â†’ ç”Ÿæˆæ–°é±¼
     */
    handleImageUpload(input) {
        if (input.files && input.files[0]) {

            if (this.fishes.length >= this.maxCapacity) {
                this.showToast("é±¼å¡˜å·²æ»¡ï¼Œè¯·å…ˆæ‰©å»ºï¼");
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            this.showToast("â³ æ­£åœ¨ç”Ÿæˆçº¹ç†...", 1200);

            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const seed = stringHash(file.name + file.size);
                    const id = Date.now();

                    const fish = new Fish(id, seed, "æ— åé±¼", img);
                    fish.y = -50;

                    this.fishes.push(fish);

                    this.showToast(`âœ¨ æ–°çš„é±¼åŠ å…¥é±¼å¡˜å•¦ï¼`);
                    this.updateUI();
                };
            };
            reader.readAsDataURL(file);
        }
        input.value = "";
    }

    /**
     * ç²’å­æ–‡å­—
     */
    createParticle(x, y, text, color) {
        this.textParticles.push({
            x, y, text, color,
            life: 60,
            vy: -1
        });
    }

    spawnPoop(x, y, color) {
        this.poops.push(new Poop(x, y, color));
    }
    spawnCoin(x, y, value) {
        this.coins.push(new Coin(x, y, value));
    }

    /**
     * å–‚é£Ÿ
     */
    feedFish(type) {
        if (this.fishes.length === 0) {
            this.showToast("è¿˜æ²¡æœ‰é±¼ï¼");
            return;
        }
        if (this.money < CONFIG.FOOD_PRICE) {
            this.showToast("é‡‘å¸ä¸è¶³ï¼");
            return;
        }

        this.money -= CONFIG.FOOD_PRICE;

        const x = randomRange(50, this.canvas.width - 50);
        this.foods.push(new Food(x, 0, type));
        this.createParticle(x, 20, "splash", "white");

        this.updateUI();
    }

    /**
     * æ‰©å»º
     */
    expandPond() {
        if (this.money < CONFIG.EXPAND_PRICE) {
            this.showToast(`éœ€è¦ $${CONFIG.EXPAND_PRICE}`);
            return;
        }

        if (this.maxCapacity >= 20) {
            this.showToast("å®¹é‡å·²æ»¡ï¼");
            return;
        }

        this.money -= CONFIG.EXPAND_PRICE;
        this.maxCapacity += 2;

        this.showToast("ğŸ‰ æ‰©å»ºæˆåŠŸï¼å®¹é‡ +2");
        this.updateUI();
    }

    /**
     * æ¸…ç†ç²‘ç²‘
     */
    cleanPond() {
        if (this.poops.length === 0) {
            this.showToast("å·²ç»å¾ˆå¹²å‡€äº†ï¼");
            return;
        }

        const n = this.poops.length;
        this.poops = [];
        this.cleanliness = Math.min(100, this.cleanliness + CONFIG.CLEAN_RECOVERY);

        this.showToast(`ğŸ§¹ æ¸…ç†äº† ${n} ä¸ªåƒåœ¾ï¼`);
        this.updateUI();
    }

    /**
     * ç‚¹å‡»é€‰æ‹©é±¼
     */
    handleClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        let clicked = null;

        for (let f of this.fishes) {
            if (Math.hypot(f.x - mx, f.y - my) < 40) {
                clicked = f;
                break;
            }
        }

        if (clicked) {
            this.selectedFish = clicked;
            ui.showDetail(clicked);
        } else {
            this.selectedFish = null;
            ui.closeDetail();
        }
    }

    /**
     * æ ¸å¿ƒé€»è¾‘å¾ªç¯
     */
    updateLogic() {
        /** æ°´è´¨é™ä½ */
        if (this.poops.length > 0) {
            this.cleanliness -= this.poops.length * CONFIG.POOP_DECAY;
            if (this.cleanliness < 0) this.cleanliness = 0;
        }

        /** æ›´æ–°å®ä½“ */
        this.bubbles.forEach((b) => b.update());
        this.foods.forEach((f) => f.update());
        this.poops.forEach((p) => p.update());
        this.coins.forEach((c) => c.update());
        this.fishes.forEach((f) => f.update(1, this.foods, this.cleanliness));

        /** ç²’å­ */
        this.textParticles.forEach((p) => {
            p.y += p.vy;
            p.life--;
        });

        /** æŠ¢é£Ÿç«äº‰ï¼ˆå…¨å±€åˆ¤å®šï¼‰ */
        for (let food of this.foods) {
    		if (food.remove) continue;

    		let bestFish = null;
    		let bestTime = Infinity;

    		for (let fish of this.fishes) {
        		// å¾ˆå¥åº·ã€å¾ˆé¥±éƒ½ä¸æŠ¢
        		if (fish.health < 10) continue;
        		if (fish.hunger > 90) continue;

        		const dx = food.x - fish.x;
        		const dy = food.y - fish.y;
        		const dist = Math.hypot(dx, dy);

        		// é¿å…é™¤ä»¥ 0
        		const speed = Math.max(0.1, fish.baseSpeed);
        		const time = dist / speed;

        		if (time < bestTime) {
            		bestTime = time;
            		bestFish = fish;
        		}
   		 }

    		if (!bestFish) continue;

    		// è®©è¿™æ¡é±¼è¿›å…¥è¿½é£ŸçŠ¶æ€
    		bestFish.state = "EAT_FOLLOW";

    		const dx = food.x - bestFish.x;
   		const dy = food.y - bestFish.y;
    		const dist = Math.hypot(dx, dy);

    		if (dist < 15) {
        		bestFish.eat(food);
        		food.remove = true;
       			continue;
   		 }

    		// å¼ºåˆ¶æœé£Ÿç‰©ç§»åŠ¨ï¼ˆé€Ÿåº¦åŠ å¤§ï¼‰
    		const speed = bestFish.baseSpeed * 1.6;
    		bestFish.vx = (dx / dist) * speed;
    		bestFish.vy = (dy / dist) * speed;
	}

        /** è‡ªåŠ¨æ”¶é‡‘å¸ */
        for (let c of this.coins) {
            if (c.autoCollectTimer <= 0 && !c.remove) {
                this.money += c.value;
                c.remove = true;
                this.createParticle(c.x, c.y, `+$${c.value}`, "#FFD700");
            }
        }

        /** æ¸…ç† remove çš„å¯¹è±¡ */
        this.foods = this.foods.filter((o) => !o.remove);
        this.coins = this.coins.filter((o) => !o.remove);
        this.poops = this.poops.filter((o) => !o.remove);
        this.textParticles = this.textParticles.filter((o) => o.life > 0);
        this.fishes = this.fishes.filter((o) => !o.remove);

        if (this.selectedFish) ui.updateDetail(this.selectedFish);
        if (Math.random() < 0.1) this.updateUI();
    }

    /**
     * ç»˜åˆ¶
     */
    draw() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;

        ctx.clearRect(0, 0, w, h);

        /** èƒŒæ™¯æ¸å˜ */
        const g = ctx.createLinearGradient(0, 0, 0, h);
        g.addColorStop(0, "#4fc3f7");
        g.addColorStop(1, "#0277bd");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);

        /** æ°´è´¨æµ‘æµŠ */
        const dirty = (100 - this.cleanliness) / 100 * 0.6;
        if (dirty > 0.05) {
            ctx.fillStyle = `rgba(50,60,20,${dirty})`;
            ctx.fillRect(0, 0, w, h);
        }

        const time = Date.now();

        this.bubbles.forEach((b) => b.draw(ctx));
        this.seaweeds.forEach((sw) => sw.draw(ctx, time));
        this.poops.forEach((p) => p.draw(ctx));
        this.foods.forEach((f) => f.draw(ctx));
        this.fishes.forEach((f) => f.draw(ctx));
        this.coins.forEach((c) => c.draw(ctx));

        this.textParticles.forEach((p) => {
            ctx.fillStyle = p.color || "white";
            ctx.font = "bold 16px Arial";
            ctx.fillText(p.text, p.x, p.y);
        });
    }

    /**
     * ä¸»å¾ªç¯
     */
    loop() {
        this.updateLogic();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }

    /**
     * Toast
     */
    showToast(msg, time = 1200) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.classList.remove("hidden", "opacity-0", "scale-90");
        t.classList.add("opacity-100", "scale-100");

        if (this.toastTimer) clearTimeout(this.toastTimer);
        this.toastTimer = setTimeout(() => {
            t.classList.remove("opacity-100", "scale-100");
            t.classList.add("opacity-0", "scale-90");
            setTimeout(() => t.classList.add("hidden"), 300);
        }, time);
    }

    updateUI() {
        document.getElementById("money-display").innerText = Math.floor(this.money);
        document.getElementById("cleanliness-display").innerText = Math.floor(this.cleanliness);
        document.getElementById("count-display").innerText = this.fishes.length;
        document.getElementById("capacity-display").innerText = this.maxCapacity;
    }
}

/* UI æ§åˆ¶å™¨ */
const ui = {
    panel: document.getElementById("fish-detail"),

    showDetail(fish) {
        this.panel.classList.remove("hidden");
        this.panel.classList.add("flex");

        document.getElementById("detail-name-input").value = fish.name;
        document.getElementById("detail-personality").innerText = fish.personality;

        const preview = document.getElementById("detail-preview");
        if (fish.image) {
            preview.style.backgroundImage = `url(${fish.image.src})`;
            preview.style.backgroundColor = "transparent";
        } else {
            preview.style.backgroundImage = "none";
            preview.style.backgroundColor = fish.baseColor;
        }

        this.updateDetail(fish);
    },

    updateDetail(fish) {
        document.getElementById("bar-health").style.width = fish.health + "%";
        document.getElementById("bar-mood").style.width = fish.mood + "%";
        document.getElementById("bar-hunger").style.width = fish.hunger + "%";

        let txt = "ğŸŸ æ‚ é—²åœ°æ¸¸åŠ¨ä¸­";
        if (fish.health < 30) txt = "ğŸ¤¢ ç”Ÿç—…äº†â€¦";
        else if (fish.hunger < 20) txt = "ğŸ˜« é¥¿å¾—æ¸¸ä¸åŠ¨äº†";

        document.getElementById("detail-status").innerText = txt;
    },

    closeDetail() {
        this.panel.classList.add("hidden");
        this.panel.classList.remove("flex");
    }
};

/* åˆ›å»ºæ¸¸æˆå®ä¾‹ */
const game = new Game();

/* åå­—ä¿å­˜æŒ‰é’® */
document.getElementById("detail-name-save").onclick = () => {
    if (!game.selectedFish) {
        game.showToast("è¯·å…ˆé€‰æ‹©ä¸€æ¡é±¼");
        return;
    }
    const newName = document.getElementById("detail-name-input").value.trim();
    if (!newName) {
        game.showToast("åå­—ä¸èƒ½ä¸ºç©º");
        return;
    }
    game.selectedFish.name = newName;
    game.showToast("åå­—å·²æ›´æ–°ï¼");
};
/* ---------------------------------------------------
   åŠ¨æ€åˆ›å»ºåº•éƒ¨æŒ‰é’®æ 
--------------------------------------------------- */
(function () {
    const uiPanel = document.querySelector(".ui-panel");

    /* åº•éƒ¨å®¹å™¨ */
    const bar = document.createElement("div");
    bar.className = "flex justify-center gap-3 pb-6 interactive";

    /* åˆ›å»ºæŒ‰é’®å‡½æ•° */
    function createButton({ icon, label, color, priceLabel, onClick }) {
        const btn = document.createElement("button");
        btn.className =
            "glass-panel p-3 hover:bg-white active:scale-95 transition flex flex-col items-center w-16 group shadow-lg";

        const iconWrap = document.createElement("div");
        iconWrap.className =
            `p-2 rounded-full mb-1 group-hover:bg-${color}-200 bg-${color}-100 transition`;
        iconWrap.innerHTML = `<i class="fas ${icon} text-xl text-${color}-600"></i>`;

        const text = document.createElement("span");
        text.className = "text-[10px] font-bold text-gray-700";
        text.innerText = label;

        btn.appendChild(iconWrap);
        btn.appendChild(text);

        if (priceLabel) {
            const price = document.createElement("span");
            price.className = "text-[9px] text-gray-500";
            price.innerText = priceLabel;
            btn.appendChild(price);
        }

        btn.addEventListener("click", onClick);
        return btn;
    }

    /* éšè— file input */
    const fileInput = document.createElement("input");
    fileInput.id = "file-input";
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.className = "hidden";
    fileInput.addEventListener("change", function () {
        game.handleImageUpload(this);
    });
    document.body.appendChild(fileInput);

    /* åˆ›å»º 4 ä¸ªæŒ‰é’® */
    const buttons = [
        createButton({
            icon: "fa-camera",
            label: "ç”Ÿæˆé±¼",
            color: "purple",
            onClick: () => fileInput.click()
        }),

        createButton({
            icon: "fa-cookie",
            label: "å–‚é£Ÿ",
            color: "orange",
            priceLabel: "-$2",
            onClick: () => game.feedFish("basic")
        }),

        createButton({
            icon: "fa-broom",
            label: "æ¸…ç†",
            color: "blue",
            onClick: () => game.cleanPond()
        }),

        createButton({
            icon: "fa-expand-arrows-alt",
            label: "æ‰©å»º",
            color: "green",
            priceLabel: "-$200",
            onClick: () => game.expandPond()
        })
    ];

    buttons.forEach((btn) => bar.appendChild(btn));
    uiPanel.appendChild(bar);
})();

</script>

<!-- Toast æ¶ˆæ¯ -->
<div id="toast"
    class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
           bg-black bg-opacity-80 text-white px-6 py-3 rounded-full hidden
           pointer-events-none transition-all scale-90 opacity-0 shadow-xl
           font-medium z-50">
    æç¤ºä¿¡æ¯
</div>

</body>
</html>
